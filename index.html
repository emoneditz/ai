<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>AI Model Hub (KaTeX)</title>
    
    <!-- Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    
    <!-- KATEX (Fast Math) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>
    
    <style>
        /* CSS STYLES */
        :root {
            --bg-body: #212121; --bg-sidebar: #171717; --bg-msg-ai: #444654;
            --bg-msg-user: #212121; --input-bg: #2f2f2f; --border: #424242;
            --text-main: #ececec; --text-muted: #b4b4b4; --green: #19c37d;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        body { margin: 0; padding: 0; height: 100dvh; width: 100vw; background-color: var(--bg-body); color: var(--text-main); font-family: -apple-system, system-ui, sans-serif; display: flex; overflow: hidden; }
        
        /* SIDEBAR */
        .sidebar { position: fixed; top: 0; left: 0; bottom: 0; width: 280px; background-color: var(--bg-sidebar); transform: translateX(-100%); transition: transform 0.3s; z-index: 100; display: flex; flex-direction: column; border-right: 1px solid #333; }
        .sidebar.open { transform: translateX(0); }
        .overlay { position: fixed; top:0; left:0; right:0; bottom:0; background: rgba(0,0,0,0.6); z-index: 90; display: none; backdrop-filter: blur(2px); }
        .overlay.active { display: block; }
        .sidebar-header { padding: 20px; font-weight: bold; border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center; }
        .model-list { flex: 1; overflow-y: auto; padding: 10px; }
        .model-btn { display: flex; justify-content: space-between; width: 100%; padding: 14px; background: transparent; border: none; color: var(--text-muted); text-align: left; border-radius: 8px; margin-bottom: 4px; font-size: 14px; }
        .model-btn.active { background-color: #343541; color: white; border: 1px solid #444; }
        .tag { font-size: 10px; padding: 3px 6px; border-radius: 4px; font-weight: bold; }
        .tag.text { background: #333; color: #aaa; } .tag.img { background: #a855f7; color: white; }

        /* MAIN VIEW */
        .main-view { flex: 1; display: flex; flex-direction: column; height: 100%; width: 100%; }
        .top-bar { height: 50px; display: flex; align-items: center; justify-content: space-between; padding: 0 15px; border-bottom: 1px solid var(--border); }
        .chat-container { flex: 1; overflow-y: auto; padding-bottom: 20px; display: flex; flex-direction: column; scroll-behavior: smooth; }
        .message { display: flex; padding: 24px 15px; gap: 15px; border-bottom: 1px solid rgba(0,0,0,0.1); font-size: 15px; line-height: 1.6; }
        .message.assistant { background-color: var(--bg-msg-ai); }
        .avatar { width: 30px; height: 30px; border-radius: 4px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
        .assistant .avatar { background: var(--green); } .user .avatar { background: #5436DA; }
        .content { flex: 1; overflow-x: hidden; word-break: break-word; }
        .content img { max-width: 100%; border-radius: 8px; margin-top: 10px; }
        pre { background: #0d0d0d; padding: 10px; border-radius: 6px; overflow-x: auto; border: 1px solid #333; }
        
        /* Math Toggle Btn */
        #mathToggle { font-size: 11px; font-weight: 600; padding: 6px 12px; background: transparent; border: 1px solid #555; color: #aaa; border-radius: 20px; cursor: pointer; transition: 0.2s; }
        
        /* INPUT AREA */
        .input-area { background-color: var(--bg-body); border-top: 1px solid var(--border); padding: 10px; padding-bottom: calc(10px + env(safe-area-inset-bottom)); }
        .input-wrapper { background-color: var(--input-bg); border-radius: 16px; padding: 8px 10px 8px 45px; display: flex; align-items: flex-end; gap: 10px; position: relative; border: 1px solid #444; }
        textarea { width: 100%; background: transparent; border: none; color: white; font-size: 16px; resize: none; height: 24px; max-height: 150px; padding: 2px 0; }
        .send-btn { background: var(--green); border: none; color: white; width: 32px; height: 32px; border-radius: 6px; display: flex; align-items: center; justify-content: center; }
        .send-btn:disabled { background: transparent; color: #555; }
        .attach-btn { position: absolute; left: 8px; bottom: 8px; background: none; border: none; color: #888; padding: 5px; }
    </style>
</head>
<body>

    <div class="overlay" onclick="toggleSidebar()"></div>
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <span>Models</span>
            <button onclick="toggleSidebar()" style="background:none;border:none;color:#aaa;">âœ•</button>
        </div>
        <div class="model-list" id="modelList"></div>
    </div>

    <div class="main-view">
        <div class="top-bar">
            <button onclick="toggleSidebar()" style="background:none;border:none;color:white;padding:5px;"><span class="material-icons-round">menu</span></button>
            <span style="font-weight:600; font-size:14px;" id="headerTitle">GPT 5.1</span>
            <!-- MATH TOGGLE BUTTON -->
            <button id="mathToggle" onclick="toggleMath()">Math: OFF</button>
        </div>

        <div class="chat-container" id="chatContainer">
            <div class="message assistant">
                <div class="avatar">ðŸ¤–</div>
                <div class="content"><p>Ready. Math rendering is OFF to save battery. Click top-right to Toggle.</p></div>
            </div>
        </div>

        <div class="input-area">
            <div class="input-wrapper">
                <button class="attach-btn"><span class="material-icons-round" style="font-size:20px;transform:rotate(45deg);">attach_file</span></button>
                <textarea id="userInput" placeholder="Message..." rows="1"></textarea>
                <button class="send-btn" id="sendBtn" onclick="sendMessage()"><span class="material-icons-round" style="font-size:18px;">arrow_upward</span></button>
            </div>
        </div>
    </div>

    <script>
        // --- CONFIG ---
        const API_KEY = "5f767344fd80741fd393672402a31dbb";
        let isMathEnabled = false; // DEFAULT IS OFF
        
        // --- TOGGLE MATH LOGIC ---
        function toggleMath() {
            isMathEnabled = !isMathEnabled;
            const btn = document.getElementById('mathToggle');
            
            if(isMathEnabled) {
                btn.innerText = "Math: ON";
                btn.style.color = "#19c37d";
                btn.style.borderColor = "#19c37d";
                btn.style.background = "rgba(25, 195, 125, 0.1)";
                // Render all existing math immediately
                renderAllMath();
            } else {
                btn.innerText = "Math: OFF";
                btn.style.color = "#aaa";
                btn.style.borderColor = "#555";
                btn.style.background = "transparent";
            }
        }

        function renderAllMath() {
            if(!window.renderMathInElement) return;
            // Scan the whole chat container
            renderMathInElement(document.getElementById('chatContainer'), {
                delimiters: [
                    {left: '$$', right: '$$', display: true},
                    {left: '$', right: '$', display: false},
                    {left: '\\(', right: '\\)', display: false},
                    {left: '\\[', right: '\\]', display: true}
                ],
                throwOnError: false
            });
        }

        // --- REST OF APP ---
        const models = [
            { id: "openai/gpt-5.1", name: "GPT 5.1", type: "text" },
            { id: "openai/o3", name: "OpenAI o3", type: "text" }
        ];
        let currentModel = models[0];
        let messages = [];

        // Init Sidebar
        models.forEach(m => {
            const btn = document.createElement('button');
            btn.className = 'model-btn' + (m.id === currentModel.id ? ' active' : '');
            btn.innerHTML = `<span>${m.name}</span><span class="tag text">TXT</span>`;
            btn.onclick = () => { currentModel = m; document.getElementById('headerTitle').innerText = m.name; toggleSidebar(); };
            document.getElementById('modelList').appendChild(btn);
        });

        function toggleSidebar() { document.getElementById('sidebar').classList.toggle('open'); document.querySelector('.overlay').classList.toggle('active'); }
        
        const userInput = document.getElementById('userInput');
        userInput.addEventListener('input', function() { this.style.height='auto'; this.style.height=Math.min(this.scrollHeight,120)+'px'; });

        async function sendMessage() {
            const text = userInput.value.trim();
            if (!text) return;
            
            addMessage('user', text);
            userInput.value = "";
            messages.push({ role: "user", content: text });
            
            const loadId = addMessage('assistant', '<span style="color:#888;">Thinking...</span>', true);

            try {
                const res = await fetch(`https://api.bytez.com/models/v2/${currentModel.id}`, {
                    method: 'POST',
                    headers: { 'Authorization': API_KEY, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ messages: messages, stream: false, params: { temperature: 1 } })
                });
                const data = await res.json();
                const out = data.output ? (data.output.content || data.output) : JSON.stringify(data);
                
                messages.push({ role: "assistant", content: out });
                updateMessage(loadId, out);
            } catch (e) { updateMessage(loadId, "Error: " + e.message); }
        }

        function addMessage(role, text, isHtml=false) {
            const div = document.createElement('div');
            div.className = `message ${role}`;
            div.id = 'msg-' + Date.now();
            div.innerHTML = `<div class="avatar">${role==='assistant'?'ðŸ¤–':'U'}</div><div class="content">${isHtml?text:'...'}</div>`;
            document.getElementById('chatContainer').appendChild(div);
            if(!isHtml) updateMessage(div.id, text);
            scrollToBottom();
            return div.id;
        }

        function updateMessage(id, text) {
            const el = document.getElementById(id);
            if(el) {
                const content = el.querySelector('.content');
                // 1. Sanitize for Markdown math protection
                let safeText = text.replace(/\\\[/g, '$$$$').replace(/\\\]/g, '$$$$').replace(/\\\(/g, '$$').replace(/\\\)/g, '$$');
                
                // 2. Parse Markdown
                content.innerHTML = marked.parse(safeText);

                // 3. IF TOGGLE IS ON -> Render Math
                if(isMathEnabled) {
                   renderAllMath(); 
                }
                
                // 4. Highlight Code
                if(content.querySelector('pre code')) hljs.highlightAll();
                
                scrollToBottom();
            }
        }
        function scrollToBottom() { window.requestAnimationFrame(() => { const c = document.getElementById('chatContainer'); c.scrollTop = c.scrollHeight; }); }
    </script>
</body>
</html>
